<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeriSkill - Analysis Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .summary-table th {
            background-color: #f1f5f9;
        }
        .summary-table th, .summary-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold text-slate-900">Analysis Results</h1>
                <p class="mt-2 text-lg text-slate-600">A detailed breakdown of the submitted resumes.</p>
            </div>
            <a href="index.html" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-200 flex items-center">
                <i class="fas fa-plus mr-2"></i>
                New Analysis
            </a>
        </header>

        <main id="results-container" class="space-y-6">
            <!-- Results will be dynamically inserted here -->
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const resultsContainer = document.getElementById('results-container');
            const resultsData = localStorage.getItem('analysisResults');

            if (!resultsData) {
                resultsContainer.innerHTML = createPlaceholderCard();
                return;
            }

            try {
                const results = JSON.parse(resultsData);
                displayResults(results);
            } catch (error) {
                console.error("Failed to parse results from localStorage", error);
                resultsContainer.innerHTML = createErrorCard('Display Error', 'Could not parse analysis results.');
            } finally {
                // Clear the stored data after displaying it
                localStorage.removeItem('analysisResults');
            }
        });

        const safeGet = (obj, path, defaultValue = '') => {
            return path.split('.').reduce((acc, part) => acc && acc[part], obj) || defaultValue;
        };

        const createSkillList = (skills, type) => {
            if (!skills || skills.length === 0) return `<p class="text-slate-400 text-sm">None identified.</p>`;
            const icon = type === 'possessed' 
                ? '<i class="fas fa-check-circle text-green-500 mr-2"></i>'
                : '<i class="fas fa-times-circle text-red-500 mr-2"></i>';
            return '<ul>' + skills.map(skill => `<li class="flex items-center text-slate-600 mb-1">${icon}<span>${skill}</span></li>`).join('') + '</ul>';
        };

        const createSummaryTable = (csvString) => {
            if (!csvString || !csvString.trim()) return '';
            const rows = csvString.trim().split('\n').map(row => row.split(','));
            const header = rows.shift();
            return `
                <div class="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">Analysis Summary</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-500 summary-table">
                                <thead class="text-xs text-slate-700 uppercase">
                                    <tr>${header.map(h => `<th scope="col" class="px-6 py-3">${h}</th>`).join('')}</tr>
                                </thead>
                                <tbody>
                                    ${rows.map(row => `<tr class="bg-white hover:bg-slate-50">${row.map(cell => `<td class="px-6 py-4">${cell}</td>`).join('')}</tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        };
        
        const displayResults = (results) => {
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.innerHTML = ''; 

            if (results.csv_summary) {
                resultsContainer.innerHTML += createSummaryTable(results.csv_summary);
            }

            const detailedResults = safeGet(results, 'detailed_results', []);
            const successfulResults = detailedResults.filter(r => r.data && r.data.match_analysis);
            const otherResults = detailedResults.filter(r => !successfulResults.includes(r));

            successfulResults.sort((a, b) => (safeGet(b, 'data.match_analysis.match_score', 0)) - (safeGet(a, 'data.match_analysis.match_score', 0)));

            const sortedResults = [...successfulResults, ...otherResults];

            if (sortedResults.length === 0 && !results.csv_summary) {
                resultsContainer.innerHTML = createPlaceholderCard();
                return;
            }
            
            sortedResults.forEach(result => {
                const cardHtml = result.data ? createSuccessCard(result) : createErrorCard(result.filename, result.reason || result.error, result.status);
                resultsContainer.innerHTML += cardHtml;
            });
        };

        const createSuccessCard = (result) => {
            const score = safeGet(result, 'data.match_analysis.match_score', 0);
            const scoreColor = score >= 75 ? 'green' : score >= 50 ? 'amber' : 'red';
            
            let emailStatusHtml = '';
            const emailNotification = safeGet(result, 'data.email_notification');
            if (emailNotification) {
                 emailStatusHtml = emailNotification.sent
                    ? `<div class="mb-4 p-3 rounded-md text-sm bg-green-50 border border-green-200 text-green-800 flex items-center"><i class="fas fa-check-circle mr-2"></i>Email notification sent successfully.</div>`
                    : `<div class="mb-4 p-3 rounded-md text-sm bg-red-50 border border-red-200 text-red-800 flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i>Email failed: ${emailNotification.status}</div>`;
            } else {
                emailStatusHtml = `<div class="mb-4 p-3 rounded-md text-sm bg-gray-100 border border-gray-200 text-gray-600 flex items-center"><i class="fas fa-info-circle mr-2"></i>Email not sent (e.g., no email found).</div>`;
            }

            return `
                <div class="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
                    <div class="p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-slate-800">${safeGet(result, 'filename', 'Unknown File')}</h3>
                                <p class="text-sm text-slate-500">${safeGet(result, 'data.resume_data.contact_info.name', 'N/A')} - ${safeGet(result, 'data.resume_data.contact_info.email', 'N/A')}</p>
                            </div>
                            <div class="w-24 text-center mt-3 sm:mt-0">
                                <div class="relative pt-1"><div class="overflow-hidden h-2 text-xs flex rounded bg-${scoreColor}-200"><div style="width:${score}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-${scoreColor}-500"></div></div></div>
                                <span class="text-2xl font-bold text-${scoreColor}-600">${score}<span class="text-base text-slate-500">/100</span></span>
                            </div>
                        </div>
                        ${emailStatusHtml}
                        <div class="mb-4">
                            <h4 class="font-semibold text-slate-600 mb-2">Analysis Summary</h4>
                            <p class="text-slate-500 text-sm">${safeGet(result, 'data.match_analysis.summary', 'No summary available.')}</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm border-t border-slate-200 pt-4">
                            <div>
                                <h4 class="font-semibold text-slate-600 mb-2">Skills Possessed</h4>
                                ${createSkillList(safeGet(result, 'data.match_analysis.skills_possessed', []), 'possessed')}
                            </div>
                            <div>
                                <h4 class="font-semibold text-slate-600 mb-2">Skills Lacking</h4>
                                ${createSkillList(safeGet(result, 'data.match_analysis.skills_lacking', []), 'lacking')}
                            </div>
                        </div>
                        <details class="mt-4">
                            <summary class="cursor-pointer font-medium text-sm text-indigo-600 hover:text-indigo-800">View Full Report (JSON)</summary>
                            <pre class="mt-2 text-xs overflow-x-auto bg-slate-50 p-3 rounded-md text-slate-600">${JSON.stringify(result.data, null, 2)}</pre>
                        </details>
                    </div>
                </div>`;
        };

        const createErrorCard = (filename, reason, status = 'ERROR') => {
             return `
                <div class="bg-white rounded-xl shadow-md border border-red-200 overflow-hidden">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-bold text-red-800">${filename}</h3>
                            <span class="text-sm font-bold bg-red-100 text-red-700 px-3 py-1 rounded-full">${status}</span>
                        </div>
                        <p class="text-red-600">${reason}</p>
                    </div>
                </div>`;
        };
        
        const createPlaceholderCard = () => {
            return `
                <div class="text-center p-12 bg-white rounded-xl shadow-md border border-slate-200">
                    <i class="fas fa-search text-6xl text-slate-300"></i>
                    <h3 class="mt-4 text-2xl font-semibold text-slate-700">No Results Found</h3>
                    <p class="text-slate-500 mt-1">Please go back and start a new analysis to see results here.</p>
                </div>`;
        };
    </script>
</body>
</html>

